generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model AccountFlag {
  id         String    @id @default(cuid())
  userId     String
  flagType   String
  reason     String?
  severity   Int       @default(2)
  addedBy    String?
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime  @default(now())

  @@index([flagType])
  @@index([resolvedAt])
  @@index([userId])
}

model AmlFlag {
  id          String    @id @default(cuid())
  userId      String
  type        String
  severity    String    @default("medium")
  description String
  ruleId      String?
  transferId  String?
  status      String    @default("open")
  resolvedBy  String?
  resolvedAt  DateTime?
  resolveNote String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([severity])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model AuditLog {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  ip           String?
  userAgent    String?
  actorUserId  String?
  amount       Decimal?
  currency     String?
  eventType    String
  fromWalletId String?
  meta         Json?
  referenceId  String?
  toWalletId   String?
  actorUser    User?    @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([createdAt])
  @@index([eventType])
}

model CardWaitlist {
  id        String   @id @default(cuid())
  fullName  String
  phone     String   @unique
  city      String?
  interest  String   @default("both")
  userId    String?
  createdAt DateTime @default(now())
}

model Case {
  id             String        @id @default(cuid())
  caseType       String
  status         String        @default("open")
  priority       String        @default("normal")
  reporterUserId String?
  subject        String?
  description    String?
  referenceType  String?
  referenceId    String?
  auditLogId     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime @updatedAt
  closedAt       DateTime?
  actions        CaseAction[]
  messages       CaseMessage[]

  @@index([caseType])
  @@index([referenceId])
  @@index([reporterUserId])
  @@index([status])
}

model CaseAction {
  id          String   @id @default(cuid())
  caseId      String
  actionType  String
  actorUserId String?
  meta        Json?
  createdAt   DateTime @default(now())
  parentCase  Case     @relation(fields: [caseId], references: [id])

  @@index([caseId])
}

model CaseMessage {
  id           String   @id @default(cuid())
  caseId       String
  authorRole   String
  authorUserId String?
  message      String
  createdAt    DateTime @default(now())
  parentCase   Case     @relation(fields: [caseId], references: [id])

  @@index([caseId])
}

model Deposit {
  id             String   @id @default(cuid())
  walletId       String
  amount         Decimal  @db.Decimal(18, 2)
  currency       String
  source         String
  reference      String?
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())
}

model DeviceSession {
  id          String    @id @default(cuid())
  userId      String
  fingerprint String
  ip          String
  userAgent   String
  lastSeenAt  DateTime  @default(now())
  createdAt   DateTime  @default(now())
  label       String?
  revokedAt   DateTime?
  trusted     Boolean   @default(false)
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model DiasporaProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  countryOfResidence String?
  city               String?
  stateProvince      String?
  postalCode         String?
  taxResidence       String?
  remittancePurpose  String?
  estimatedMonthly   Decimal? @db.Decimal(18, 2)
  preferredCurrency  String   @default("USD")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Distributor {
  id                  String                @id @default(cuid())
  userId              String                @unique
  businessName        String?
  status              String                @default("pending")
  createdAt           DateTime              @default(now())
  updatedAt           DateTime @updatedAt
  commissionIn        Decimal               @default(0.01)
  commissionOut       Decimal               @default(0.02)
  displayName         String?
  locationText        String?
  phonePublic         String?
  tier                String                @default("agent")
  user                User                  @relation(fields: [userId], references: [id])
  recharges           DistributorRecharge[]

  @@index([status])
}

model DistributorCommission {
  id            String   @id @default(cuid())
  distributorId String
  txnId         String
  amount        Decimal
  currency      String
  status        String   @default("earned")
  createdAt     DateTime @default(now())

  @@index([distributorId])
  @@index([status])
}

model DistributorRecharge {
  id            String      @id @default(cuid())
  distributorId String
  amount        Decimal
  currency      String      @default("HTG")
  method        String
  reference     String?
  proofUrl      String?
  status        String      @default("pending")
  reviewedBy    String?
  reviewNote    String?
  reviewedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime @updatedAt
  distributor   Distributor @relation(fields: [distributorId], references: [id])

  @@index([createdAt])
  @@index([distributorId])
  @@index([status])
}

model DistributorSettlement {
  id            String   @id @default(cuid())
  distributorId String
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  type          String
  createdAt     DateTime @default(now())
}

model DistributorTxn {
  id                  String   @id @default(cuid())
  distributorId       String
  type                String
  status              String   @default("completed")
  clientUserId        String?
  clientWalletId      String?
  distributorWalletId String?
  amount              Decimal
  currency            String
  commission          Decimal  @default(0)
  referenceId         String?
  meta                Json?
  createdAt           DateTime @default(now())

  @@index([createdAt])
  @@index([distributorId])
  @@index([type])
}

model DomainEvent {
  id        String    @id @default(cuid())
  name      String
  payload   Json
  createdAt DateTime  @default(now())
  handledAt DateTime?
  status    String    @default("queued")
  error     String?
}

model FamilyLink {
  id                                   String   @id @default(cuid())
  diasporaUserId                       String
  familyUserId                         String
  nickname                             String?
  relationship                         String?
  createdAt                            DateTime @default(now())
  isFavorite                           Boolean  @default(false)
  diasporaUser User     @relation("FamilyLink_diasporaUserIdToUser", fields: [diasporaUserId], references: [id])
  familyUser   User     @relation("FamilyLink_familyUserIdToUser", fields: [familyUserId], references: [id])

  @@unique([diasporaUserId, familyUserId])
  @@index([diasporaUserId])
}

model FeeConfig {
  id        String   @id @default(cuid())
  type      String
  percent   Decimal  @default(0) @db.Decimal(8, 4)
  flat      Decimal  @default(0) @db.Decimal(18, 2)
  currency  String   @default("HTG")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([type, currency])
}

model FloatRefillLog {
  id            String   @id @default(cuid())
  distributorId String
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  performedBy   String
  note          String?
  createdAt     DateTime @default(now())
}

model FloatTransfer {
  id                String   @id @default(cuid())
  fromDistributorId String
  toDistributorId   String
  amount            Decimal  @db.Decimal(18, 2)
  currency          String
  status            String   @default("completed")
  createdAt         DateTime @default(now())
}

model FxConversion {
  id           String   @id @default(cuid())
  userId       String
  fromCurrency String
  toCurrency   String
  fromAmount   Decimal  @db.Decimal(18, 2)
  toAmount     Decimal  @db.Decimal(18, 2)
  rateUsed     Decimal  @db.Decimal(18, 6)
  spreadBps    Int      @default(0)
  profit       Decimal  @default(0) @db.Decimal(18, 2)
  reference    String?
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model FxPromoRedemption {
  id              String      @id @default(cuid())
  promotionId     String
  userId          String
  transferId      String?
  savedAmount     Decimal
  affiliateUserId String?
  affiliatePaid   Boolean     @default(false)
  createdAt       DateTime    @default(now())
  promotion       FxPromotion @relation(fields: [promotionId], references: [id])

  @@index([affiliateUserId])
  @@index([promotionId])
  @@index([userId])
}

model FxPromotion {
  id               String              @id @default(cuid())
  name             String
  fromCurrency     String
  toCurrency       String
  discountBps      Int
  bonusPct         Decimal?
  minAmount        Decimal?
  maxAmount        Decimal?
  code             String?             @unique
  corridor         String?
  maxUses          Int?
  usedCount        Int                 @default(0)
  startsAt         DateTime
  endsAt           DateTime
  active           Boolean             @default(true)
  // Affiliate tracking
  affiliateUserId  String?
  affiliatePct     Decimal?            @db.Decimal(8, 4)
  affiliateLabel   String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime @updatedAt

  @@index([affiliateUserId])
  redemptions  FxPromoRedemption[]

  @@index([code])
  @@index([fromCurrency, toCurrency])
  @@index([startsAt, endsAt])
}

model FxRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Decimal
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  buy          Decimal? @db.Decimal(18, 6)
  mid          Decimal? @db.Decimal(18, 6)
  sell         Decimal? @db.Decimal(18, 6)
  source       String   @default("manual")
  spreadBps    Int      @default(0)

  @@index([fromCurrency, toCurrency, active])
}

model IdempotencyKey {
  id          String   @id @default(cuid())
  userId      String?
  key         String
  route       String
  requestHash String
  response    Json
  status      String   @default("completed")
  createdAt   DateTime @default(now())

  @@unique([key, route])
  @@index([createdAt])
  @@index([userId])
}

model KycProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  documentType    String?
  documentUrl     String?
  selfieUrl       String?
  addressProof    String?
  submittedAt     DateTime?
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime @updatedAt
  address         String?
  country         String?
  dob             DateTime?
  fullName        String?
  idNumber        String?
  user            User      @relation(fields: [userId], references: [id])
}

model LedgerEntry {
  id         String   @id @default(cuid())
  walletId   String
  amount     Decimal  @db.Decimal(18, 2)
  type       String
  createdAt  DateTime @default(now())
  transferId String?
  reference  String?
  wallet     Wallet   @relation(fields: [walletId], references: [id])
}

model LimitConfig {
  id          String  @id @default(cuid())
  tier        Int     @unique
  dailySend   Decimal @db.Decimal(18, 2)
  monthlySend Decimal @db.Decimal(18, 2)
}

model LimitUsage {
  id             String   @id @default(cuid())
  userId         String
  currency       String
  dailyUsed      Decimal  @default(0) @db.Decimal(18, 2)
  monthlyUsed    Decimal  @default(0) @db.Decimal(18, 2)
  dailyResetAt   DateTime
  monthlyResetAt DateTime
  updatedAt      DateTime @updatedAt

  @@unique([userId, currency])
}

model Merchant {
  id                 String               @id @default(cuid())
  userId             String               @unique
  businessName       String
  paymentCode        String               @unique
  logoUrl            String?
  phone              String?
  category           String?
  kycStatus          String               @default("pending")
  status             String               @default("pending")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime @updatedAt
  user               User                 @relation(fields: [userId], references: [id])
  feeProfile         MerchantFeeProfile?
  posRequests        MerchantPosRequest[]
  withdrawals        MerchantWithdrawal[]
}

model MerchantFeeProfile {
  id         String   @id @default(cuid())
  merchantId String   @unique
  mode       String   @default("percent")
  percentBps Int      @default(75)
  fixedFee   Decimal  @default(0) @db.Decimal(18, 2)
  currency   String   @default("HTG")
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  merchant   Merchant @relation(fields: [merchantId], references: [id])
}

model MerchantPosRequest {
  id           String    @id @default(cuid())
  merchantId   String
  amount       Decimal   @db.Decimal(18, 2)
  currency     String    @default("HTG")
  note         String?
  status       String    @default("pending")
  signature    String
  expiresAt    DateTime
  paidByUserId String?
  paidAt       DateTime?
  transferId   String?
  createdAt    DateTime  @default(now())
  merchant     Merchant  @relation(fields: [merchantId], references: [id])

  @@index([expiresAt])
  @@index([merchantId])
  @@index([status])
}

model MerchantWithdrawal {
  id            String    @id @default(cuid())
  merchantId    String
  walletId      String
  amount        Decimal
  currency      String
  code          String    @unique
  status        String    @default("pending")
  distributorId String?
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
  merchant      Merchant  @relation(fields: [merchantId], references: [id])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  title       String
  body        String
  type        String
  read        Boolean  @default(false)
  data        Json?
  createdAt   DateTime @default(now())
  params      Json?
  templateKey String?
  user        User     @relation(fields: [userId], references: [id])
}

model NotificationLog {
  id        String    @id @default(cuid())
  channel   String    @default("sms")
  type      String
  to        String
  body      String
  status    String    @default("queued")
  error     String?
  jobId     String?
  userId    String?
  attempts  Int       @default(0)
  sentAt    DateTime?
  createdAt DateTime  @default(now())
}

model OtpChallenge {
  id         String   @id @default(cuid())
  userId     String
  transferId String?
  reason     String
  otpCode    String
  status     String   @default("pending")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  payload    Json?
  purpose    String   @default("transfer")

  @@index([status])
  @@index([userId])
}

model OtpCode {
  id          String    @id @default(cuid())
  userId      String?
  phone       String
  code        String
  purpose     String
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
}

model PaymentRequest {
  id                                    String    @id @default(cuid())
  requesterId                           String
  requesteeId                           String
  amount                                Decimal   @db.Decimal(18, 2)
  currency                              String    @default("HTG")
  note                                  String?
  status                                String    @default("pending")
  paidAt                                DateTime?
  createdAt                             DateTime  @default(now())
  requestee User      @relation("PaymentRequest_requesteeIdToUser", fields: [requesteeId], references: [id])
  requester User      @relation("PaymentRequest_requesterIdToUser", fields: [requesterId], references: [id])
}

model PlatformPlan {
  id            String     @id @default(cuid())
  slug          String     @unique
  role          String
  tier          Int        @default(1)
  priceUsd      Decimal    @db.Decimal(18, 2)
  interval      String     @default("monthly")
  stripePriceId String?    @unique
  features      Json?
  nameEn        String
  nameFr        String
  nameHt        String
  nameEs        String
  descEn        String?
  descFr        String?
  descHt        String?
  descEs        String?
  active        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime @updatedAt
  userPlans     UserPlan[]

  @@index([role])
  @@index([tier])
}

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([token])
  @@index([userId])
}

model ReceiveCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model RecipientInteraction {
  id              String   @id @default(cuid())
  userId          String
  recipientUserId String
  interactionType String
  amount          Decimal  @db.Decimal(18, 2)
  createdAt       DateTime @default(now())

  @@index([userId, recipientUserId])
}

model ReconciliationRun {
  id         String    @id @default(cuid())
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("running")
  summary    Json?
  error      String?
}

model Reversal {
  id             String   @id @default(cuid())
  targetType     String
  targetId       String
  reason         String
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())
}

model RiskEvent {
  id         String   @id @default(cuid())
  userId     String
  eventType  String
  riskScore  Int
  riskLevel  String
  reasons    Json
  action     String
  transferId String?
  ip         String?
  userAgent  String?
  meta       Json?
  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([riskLevel, createdAt])
  @@index([userId])
}

model RiskFlag {
  id         String    @id @default(cuid())
  userId     String
  type       String
  severity   Int
  details    Json?
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
}

model RoleLimitProfile {
  id           String   @id @default(cuid())
  role         String
  currency     String
  dailyLimit   Decimal  @db.Decimal(18, 2)
  monthlyLimit Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())

  @@unique([role, currency])
}

model SanctionsCheck {
  id        String   @id @default(cuid())
  userId    String
  fullName  String
  country   String?
  result    String
  source    String   @default("manual")
  matchData Json?
  checkedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model ScheduledTransfer {
  id                                           String    @id @default(cuid())
  senderUserId                                 String
  recipientUserId                              String
  familyLinkId                                 String?
  amountUsd                                    Decimal   @db.Decimal(18, 2)
  frequency                                    String    @default("monthly")
  nextRunAt                                    DateTime
  lastRunAt                                    DateTime?
  lastTransferId                               String?
  failureCount                                 Int       @default(0)
  status                                       String    @default("active")
  note                                         String?
  createdAt                                    DateTime  @default(now())
  updatedAt                                    DateTime @updatedAt
  recipient User      @relation("ScheduledTransfer_recipientUserIdToUser", fields: [recipientUserId], references: [id])
  sender    User      @relation("ScheduledTransfer_senderUserIdToUser", fields: [senderUserId], references: [id])

  @@index([senderUserId])
  @@index([status, nextRunAt])
}

model StepUpToken {
  id        String    @id @default(cuid())
  userId    String
  scope     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SubscriptionCatalogItem {
  id               String             @id @default(cuid())
  merchantKey      String             @unique
  category         String
  nameEn           String
  nameFr           String
  nameHt           String
  nameEs           String
  descEn           String?
  descFr           String?
  descHt           String?
  descEs           String?
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime @updatedAt
  plans SubscriptionPlan[]
}

model SubscriptionPlan {
  id                      String                  @id @default(cuid())
  itemId                  String
  planKey                 String                  @unique
  amountUsd               Decimal                 @db.Decimal(18, 2)
  interval                String                  @default("monthly")
  labelEn                 String
  labelFr                 String
  labelHt                 String
  labelEs                 String
  active                  Boolean                 @default(true)
  createdAt               DateTime                @default(now())
  updatedAt               DateTime @updatedAt
  catalogItem SubscriptionCatalogItem @relation(fields: [itemId], references: [id])

  @@index([itemId])
}

model SubscriptionProxy {
  id                 String    @id @default(cuid())
  userId             String
  merchant           String
  externalAccountRef String?
  amountUsd          Decimal   @db.Decimal(18, 2)
  currency           String    @default("USD")
  status             String    @default("active")
  nextBilling        DateTime
  lastCharged        DateTime?
  lastAttempt        DateTime?
  failureCount       Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime @updatedAt
  meta               Json?

  @@index([merchant])
  @@index([nextBilling])
  @@index([status])
  @@index([userId])
}

model Transfer {
  id             String    @id @default(cuid())
  amount         Decimal   @db.Decimal(18, 2)
  createdAt      DateTime  @default(now())
  currency       String
  fromWalletId   String
  idempotencyKey String    @unique
  status         String    @default("posted")
  toWalletId     String
  senderUserId   String
  reviewNote     String?
  reviewedAt     DateTime?
  reviewedBy     String?
  riskEventId    String?

  @@index([status])
}

model TransferContact {
  id                                       String   @id @default(cuid())
  userId                                   String
  contactUserId                            String
  nickname                                 String?
  transferCount                            Int      @default(1)
  lastTransferAt                           DateTime @default(now())
  createdAt                                DateTime @default(now())
  isFavorite                               Boolean  @default(false)
  contactUser User     @relation("TransferContact_contactUserIdToUser", fields: [contactUserId], references: [id])
  owner       User     @relation("TransferContact_userIdToUser", fields: [userId], references: [id])

  @@unique([userId, contactUserId])
}

model UnlockRequest {
  id         String    @id @default(cuid())
  userId     String
  reason     String?
  status     String    @default("pending")
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id])
}

model User {
  id                                                        String              @id @default(cuid())
  phone                                                     String?
  role                                                      String
  createdAt                                                 DateTime            @default(now())
  auth0Id                                                   String?             @unique
  kycTier                                                   Int                 @default(0)
  dailyTransferLimit                                        Decimal             @default(5000)
  email                                                     String?
  firstName                                                 String?
  freezeReason                                              String?
  frozenAt                                                  DateTime?
  handle                                                    String?             @unique
  isFrozen                                                  Boolean             @default(false)
  kycStatus                                                 String              @default("none")
  lastName                                                  String?
  preferredLang                                             String              @default("en")
  kId                                                       String?             @unique
  supabaseId                                                String?             @unique
  country                                                   String?
  dateOfBirth                                               DateTime?
  onboardingComplete                                        Boolean             @default(false)
  phoneVerified                                             Boolean             @default(false)
  profileComplete                                           Boolean             @default(false)
  profilePhotoUrl                                           String?
  transactionPinHash                                        String?
  referralCode                                              String?             @unique
  referredBy                                                String?
  updatedAt                                                 DateTime            @updatedAt

  @@index([referralCode])
  @@index([referredBy])
  amlFlags                   AmlFlag[]
  auditLogs                  AuditLog[]
  deviceSessions             DeviceSession[]
  diasporaProfile            DiasporaProfile?
  distributor                Distributor?
  familyLinksAsDiaspora      FamilyLink[]        @relation("FamilyLink_diasporaUserIdToUser")
  familyLinksAsFamily        FamilyLink[]        @relation("FamilyLink_familyUserIdToUser")
  kycProfile                 KycProfile?
  merchant                   Merchant?
  notifications              Notification[]
  paymentRequestsReceived    PaymentRequest[]    @relation("PaymentRequest_requesteeIdToUser")
  paymentRequestsSent        PaymentRequest[]    @relation("PaymentRequest_requesterIdToUser")
  pushTokens                 PushToken[]
  receiveCodes               ReceiveCode[]
  sanctionsChecks            SanctionsCheck[]
  scheduledTransfersReceived ScheduledTransfer[] @relation("ScheduledTransfer_recipientUserIdToUser")
  scheduledTransfersSent     ScheduledTransfer[] @relation("ScheduledTransfer_senderUserIdToUser")
  stepUpTokens               StepUpToken[]
  contactedBy                TransferContact[]   @relation("TransferContact_contactUserIdToUser")
  contacts                   TransferContact[]   @relation("TransferContact_userIdToUser")
  unlockRequests             UnlockRequest[]
  wallets                    Wallet[]
}

model UserPlan {
  id                   String       @id @default(cuid())
  userId               String
  planId               String
  stripeSubscriptionId String?      @unique
  stripeCustomerId     String?
  status               String       @default("active")
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  canceledAt           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime @updatedAt
  plan                 PlatformPlan @relation(fields: [planId], references: [id])

  @@unique([userId, planId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([userId])
}

model VirtualCard {
  id             String           @id @default(cuid())
  userId         String
  cardNumberEnc  String
  fingerprint    String           @unique
  last4          String
  brand          String           @default("KOBKLEIN")
  expiryMonth    Int
  expiryYear     Int
  cvvHash        String
  currency       String           @default("USD")
  status         String           @default("active")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime @updatedAt
  transactions VirtualCardTxn[]

  @@index([userId])
}

model VirtualCardTxn {
  id               String      @id @default(cuid())
  cardId           String
  userId           String
  status           String      @default("authorized")
  amount           Decimal     @db.Decimal(18, 2)
  currency         String
  merchantName     String?
  merchantCategory String?
  merchantCountry  String?
  holdId           String?
  captureLedgerId  String?
  meta             Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime @updatedAt
  card             VirtualCard @relation(fields: [cardId], references: [id])

  @@index([cardId])
  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model Wallet {
  id          String        @id @default(cuid())
  userId      String
  currency    String
  createdAt   DateTime      @default(now())
  type        WalletType    @default(USER)
  ledgerEntries LedgerEntry[]
  user          User          @relation(fields: [userId], references: [id])

  @@unique([userId, currency])
}

model WebhookEvent {
  id          String    @id @default(cuid())
  provider    String
  eventId     String
  type        String
  payload     Json
  receivedAt  DateTime  @default(now())
  processedAt DateTime?
  status      String    @default("received")
  error       String?

  @@unique([provider, eventId])
}

model Withdrawal {
  id            String   @id @default(cuid())
  userId        String
  walletId      String
  distributorId String?
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  status        String   @default("pending")
  code          String   @unique
  expiresAt     DateTime
  feeAmount     Decimal? @db.Decimal(18, 2)
  netAmount     Decimal? @db.Decimal(18, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum WalletType {
  USER
  DISTRIBUTOR
  MERCHANT
  SYSTEM
  TREASURY
}
