generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum WalletType {
  USER
  DISTRIBUTOR
  MERCHANT
  SYSTEM
  TREASURY
}

model User {
  id           String   @id @default(uuid())
  auth0Id      String   @unique
  phone        String?
  role         String   // user, merchant, distributor, admin, diaspora
  firstName    String?
  lastName     String?
  email        String?
  handle       String?  @unique
  kId          String?  @unique  // KP-XXXXXX — KobKlein Platform ID
  kycTier      Int      @default(0)
  kycStatus    String   @default("none") // none, pending, approved, rejected
  isFrozen     Boolean  @default(false)
  freezeReason String?
  frozenAt     DateTime?
  createdAt    DateTime @default(now())
  dailyTransferLimit Decimal @default(5000)
  preferredLang      String  @default("en") // en | fr | ht | es

  wallets             Wallet[]
  distributor         Distributor?
  merchant            Merchant?
  contacts            TransferContact[]   @relation("userContacts")
  contactOf           TransferContact[]   @relation("contactUser")
  deviceSessions      DeviceSession[]
  notifications       Notification[]
  sentRequests        PaymentRequest[]    @relation("requester")
  receivedRequests    PaymentRequest[]    @relation("requestee")
  receiveCodes        ReceiveCode[]
  kycProfile          KycProfile?
  familyLinksAsOwner  FamilyLink[]        @relation("diasporaOwner")
  familyLinksAsMember FamilyLink[]        @relation("familyMember")
  unlockRequests      UnlockRequest[]
  auditLogs           AuditLog[]
  scheduledSent       ScheduledTransfer[] @relation("scheduledSender")
  scheduledReceived   ScheduledTransfer[] @relation("scheduledRecipient")
}

model Distributor {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  displayName    String?
  businessName   String?
  phonePublic    String?  // optional public phone for customers (NOT required)
  locationText   String?  // "Port-au-Prince, Delmas 33" (no formal address needed)
  status         String   @default("pending") // pending | active | suspended | rejected

  tier           String   @default("agent") // agent (future: master)
  commissionIn   Decimal  @default(0.01)    // 1% cash-in
  commissionOut  Decimal  @default(0.02)    // 2% cash-out

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
}

model DistributorTxn {
  id              String   @id @default(cuid())
  distributorId   String
  type            String   // cash_in | cash_out | float_refill | float_withdraw
  status          String   @default("completed") // completed | reversed | failed

  clientUserId    String?
  clientWalletId  String?
  distributorWalletId String?

  amount          Decimal
  currency        String

  commission      Decimal  @default(0)
  referenceId     String?  // links to transfer/ledger reference
  meta            Json?

  createdAt       DateTime @default(now())

  @@index([distributorId])
  @@index([type])
  @@index([createdAt])
}

model DistributorCommission {
  id            String   @id @default(cuid())
  distributorId String
  txnId         String
  amount        Decimal
  currency      String
  status        String   @default("earned") // earned | paid_out | reversed
  createdAt     DateTime @default(now())

  @@index([distributorId])
  @@index([status])
}

model Wallet {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  currency  String     // HTG, USD
  type      WalletType @default(USER)
  createdAt DateTime   @default(now())
  entries   LedgerEntry[]

  @@unique([userId, currency])
}

model LedgerEntry {
  id         String   @id @default(uuid())
  walletId   String
  wallet     Wallet   @relation(fields: [walletId], references: [id])
  amount     Decimal  @db.Decimal(18, 2) // + or -
  type       String   // transfer_debit, transfer_credit, deposit, fee, hold_debit, hold_release, hold_seize
  transferId String?
  reference  String?  // generic reference (caseId for holds, etc.)
  createdAt  DateTime @default(now())
}

model Transfer {
  id             String   @id @default(uuid())
  fromWalletId   String
  toWalletId     String
  amount         Decimal  @db.Decimal(18, 2)
  currency       String
  status         String   @default("posted") // posted, completed, pending_review, blocked, reversed
  senderUserId   String
  idempotencyKey String   @unique
  riskEventId    String?  // links to RiskEvent that flagged this transfer
  reviewedBy     String?  // admin userId who approved/rejected
  reviewedAt     DateTime?
  reviewNote     String?
  createdAt      DateTime @default(now())

  @@index([status])
}

model Deposit {
  id             String   @id @default(uuid())
  walletId       String
  amount         Decimal  @db.Decimal(18, 2)
  currency       String
  source         String   // stripe, distributor, manual, migration
  reference      String?
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())
}

model Withdrawal {
  id            String   @id @default(uuid())
  userId        String
  walletId      String
  distributorId String?
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  status        String   @default("pending") // pending, approved, rejected, completed
  code          String   @unique
  expiresAt     DateTime
  feeAmount     Decimal? @db.Decimal(18, 2)
  netAmount     Decimal? @db.Decimal(18, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DistributorSettlement {
  id            String   @id @default(uuid())
  distributorId String
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  type          String // float_topup, reconciliation

  createdAt DateTime @default(now())
}

model LimitConfig {
  id          String  @id @default(uuid())
  tier        Int     @unique
  dailySend   Decimal @db.Decimal(18, 2)
  monthlySend Decimal @db.Decimal(18, 2)
}

// ── Phase 43: Role-Based Limit Engine ───────────────────────────────

model RoleLimitProfile {
  id            String   @id @default(cuid())
  role          String   // user | diaspora | merchant | distributor
  currency      String   // USD | HTG
  dailyLimit    Decimal  @db.Decimal(18, 2)
  monthlyLimit  Decimal  @db.Decimal(18, 2)
  createdAt     DateTime @default(now())

  @@unique([role, currency])
}

model LimitUsage {
  id             String   @id @default(cuid())
  userId         String
  currency       String
  dailyUsed      Decimal  @db.Decimal(18, 2) @default(0)
  monthlyUsed    Decimal  @db.Decimal(18, 2) @default(0)
  dailyResetAt   DateTime
  monthlyResetAt DateTime
  updatedAt      DateTime @updatedAt

  @@unique([userId, currency])
}

model RiskFlag {
  id         String   @id @default(uuid())
  userId     String
  type       String   // velocity, failed_attempts, suspicious_pattern
  severity   Int      // 1=low, 2=med, 3=high, 4=critical
  details    Json?
  createdAt  DateTime @default(now())
  resolvedAt DateTime?
}

model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String?
  eventType    String
  amount       Decimal?
  currency     String?
  fromWalletId String?
  toWalletId   String?
  referenceId  String?
  ip           String?
  userAgent    String?
  meta         Json?
  createdAt    DateTime @default(now())

  // Relations
  actorUser    User?    @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([eventType])
  @@index([createdAt])
}

model WebhookEvent {
  id          String   @id @default(uuid())
  provider    String   // stripe, twilio, kyc, internal
  eventId     String   // provider unique id (e.g. stripe evt_...)
  type        String   // event type string
  payload     Json
  receivedAt  DateTime @default(now())
  processedAt DateTime?
  status      String   @default("received") // received, processed, failed
  error       String?

  @@unique([provider, eventId])
}

model DomainEvent {
  id         String   @id @default(uuid())
  name       String   // transfer.posted, deposit.posted, kyc.approved...
  payload    Json
  createdAt  DateTime @default(now())
  handledAt  DateTime?
  status     String   @default("queued") // queued, handled, failed
  error      String?
}

model ReconciliationRun {
  id         String    @id @default(uuid())
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  status     String    @default("running") // running, success, failed
  summary    Json?
  error      String?
}

model Reversal {
  id             String   @id @default(uuid())
  targetType     String   // transfer, deposit, withdrawal
  targetId       String
  reason         String
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())
}

model Case {
  id            String   @id @default(cuid())
  caseType      String   // wrong_recipient | unauthorized | merchant_dispute
  status        String   @default("open") // open | investigating | pending_user | pending_admin | resolved | rejected
  priority      String   @default("normal") // low | normal | high | critical

  reporterUserId String?
  subject       String?
  description   String?

  // Link to financial truth
  referenceType String?  // transfer | merchant_payment | cashout | deposit
  referenceId   String?  // transferId / audit referenceId
  auditLogId    String?  // optional direct pointer

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  closedAt      DateTime?

  messages CaseMessage[]
  actions  CaseAction[]

  @@index([reporterUserId])
  @@index([status])
  @@index([caseType])
  @@index([referenceId])
}

model CaseMessage {
  id        String   @id @default(cuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id])
  authorRole String  // user | admin | system
  authorUserId String?
  message   String
  createdAt DateTime @default(now())

  @@index([caseId])
}

model CaseAction {
  id         String   @id @default(cuid())
  caseId     String
  case       Case     @relation(fields: [caseId], references: [id])
  actionType String   // freeze_account | unfreeze_account | request_info | mark_fraud | refund_recommendation | close_case
  actorUserId String?
  meta       Json?
  createdAt  DateTime @default(now())

  @@index([caseId])
}

// ── New models ──────────────────────────────────────────────────────

model TransferContact {
  id            String   @id @default(uuid())
  userId        String
  contactUserId String
  nickname      String?
  isFavorite    Boolean  @default(false)
  transferCount Int      @default(1)
  lastTransferAt DateTime @default(now())
  createdAt     DateTime @default(now())

  user        User @relation("userContacts", fields: [userId], references: [id])
  contactUser User @relation("contactUser", fields: [contactUserId], references: [id])

  @@unique([userId, contactUserId])
}

model OtpCode {
  id        String   @id @default(uuid())
  userId    String?
  phone     String
  code      String
  purpose   String   // login, transfer, freeze, unlock
  attempts  Int      @default(0)
  maxAttempts Int    @default(5)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model Merchant {
  id           String   @id @default(uuid())
  userId       String   @unique
  businessName String
  paymentCode  String   @unique
  logoUrl      String?
  phone        String
  category     String?
  kycStatus    String   @default("pending") // pending, approved, rejected
  status       String   @default("active")  // active, suspended
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user        User @relation(fields: [userId], references: [id])
  withdrawals MerchantWithdrawal[]
  posRequests MerchantPosRequest[]
  feeProfile  MerchantFeeProfile?
}

model MerchantWithdrawal {
  id            String   @id @default(uuid())
  merchantId    String
  walletId      String
  amount        Decimal
  currency      String
  code          String   @unique
  status        String   @default("pending")
  distributorId String?
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  merchant Merchant @relation(fields: [merchantId], references: [id])
}

model DeviceSession {
  id          String   @id @default(cuid())
  userId      String
  fingerprint String
  ip          String
  userAgent   String
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  title       String   // Fallback / default-language text
  body        String   // Fallback / default-language text
  type        String   // transfer, deposit, withdrawal, security, merchant, system, subscription_due, low_balance
  read        Boolean  @default(false)
  data        Json?
  templateKey String?  // i18n template key (e.g. "subscription_due") — optional, new notifications use this
  params      Json?    // Template params for i18n rendering
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model PaymentRequest {
  id          String   @id @default(uuid())
  requesterId String
  requesteeId String
  amount      Decimal  @db.Decimal(18, 2)
  currency    String   @default("HTG")
  note        String?
  status      String   @default("pending") // pending, paid, declined, expired
  paidAt      DateTime?
  createdAt   DateTime @default(now())

  requester User @relation("requester", fields: [requesterId], references: [id])
  requestee User @relation("requestee", fields: [requesteeId], references: [id])
}

model ReceiveCode {
  id        String   @id @default(uuid())
  userId    String
  code      String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RecipientInteraction {
  id              String   @id @default(uuid())
  userId          String
  recipientUserId String
  interactionType String   // send, receive, request
  amount          Decimal  @db.Decimal(18, 2)
  createdAt       DateTime @default(now())

  @@index([userId, recipientUserId])
}

model KycProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  fullName       String?
  dob            DateTime?
  country        String?
  address        String?
  documentType   String?  // national_id, passport, drivers_license
  idNumber       String?
  documentUrl    String?
  selfieUrl      String?
  addressProof   String?
  submittedAt    DateTime?
  reviewedAt     DateTime?
  reviewedBy     String?
  rejectionReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model FeeConfig {
  id        String   @id @default(uuid())
  type      String   // merchant_payment, withdrawal, transfer, deposit
  percent   Decimal  @db.Decimal(8, 4) @default(0)
  flat      Decimal  @db.Decimal(18, 2) @default(0)
  currency  String   @default("HTG")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([type, currency])
}

model FloatRefillLog {
  id            String   @id @default(uuid())
  distributorId String
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  performedBy   String   // admin userId
  note          String?
  createdAt     DateTime @default(now())
}

model FloatTransfer {
  id                String   @id @default(uuid())
  fromDistributorId String
  toDistributorId   String
  amount            Decimal  @db.Decimal(18, 2)
  currency          String
  status            String   @default("completed")
  createdAt         DateTime @default(now())
}

model OtpChallenge {
  id         String   @id @default(uuid())
  userId     String
  transferId String?
  reason     String   // high_amount, new_device, new_recipient, risk_score
  otpCode    String
  purpose    String   @default("transfer") // transfer, merchant_payment, cashout
  payload    Json?    // pending transaction details (IDs + amounts only)
  status     String   @default("pending") // pending, used, expired
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([status])
}

model UnlockRequest {
  id         String    @id @default(uuid())
  userId     String
  reason     String?
  status     String    @default("pending") // pending, approved, rejected
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}

model FamilyLink {
  id              String   @id @default(cuid())
  diasporaUserId  String
  familyUserId    String
  nickname        String?  // "Mom", "Cousin", "School"
  relationship    String?  // "mother", "father", "cousin", "friend"
  isFavorite      Boolean  @default(false)
  createdAt       DateTime @default(now())

  diasporaUser    User     @relation("diasporaOwner", fields: [diasporaUserId], references: [id])
  familyUser      User     @relation("familyMember", fields: [familyUserId], references: [id])

  @@unique([diasporaUserId, familyUserId])
  @@index([diasporaUserId])
}

model IdempotencyKey {
  id          String   @id @default(cuid())
  userId      String?
  key         String
  route       String
  requestHash String
  response    Json
  status      String   @default("completed") // completed | processing | failed
  createdAt   DateTime @default(now())

  @@unique([key, route])
  @@index([userId])
  @@index([createdAt])
}

model NotificationLog {
  id        String    @id @default(uuid())
  channel   String    @default("sms") // sms, push, email
  type      String
  to        String
  body      String
  status    String    @default("queued") // queued, sent, failed
  error     String?
  jobId     String?
  userId    String?
  attempts  Int       @default(0)
  sentAt    DateTime?
  createdAt DateTime  @default(now())
}

model CardWaitlist {
  id        String   @id @default(uuid())
  fullName  String
  phone     String
  city      String?
  interest  String   @default("both") // virtual, physical, both
  userId    String?
  createdAt DateTime @default(now())

  @@unique([phone])
}

model FxRate {
  id           String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate         Decimal  // legacy field — kept for backward compat
  mid          Decimal? @db.Decimal(18, 6) // market mid rate
  buy          Decimal? @db.Decimal(18, 6) // platform buys quote (user receives)
  sell         Decimal? @db.Decimal(18, 6) // platform sells quote
  spreadBps    Int      @default(0)        // spread in basis points (250 = 2.5%)
  source       String   @default("manual") // manual | api
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([fromCurrency, toCurrency, active])
}

// ── Phase 44: FX Conversion Audit Trail ─────────────────────────────

model FxConversion {
  id          String   @id @default(cuid())
  userId      String
  fromCurrency String
  toCurrency  String
  fromAmount  Decimal  @db.Decimal(18, 2)
  toAmount    Decimal  @db.Decimal(18, 2)
  rateUsed    Decimal  @db.Decimal(18, 6)
  spreadBps   Int      @default(0)
  profit      Decimal  @db.Decimal(18, 2) @default(0) // platform profit from spread
  reference   String?  // e.g., "transfer:xxx" or "schedule:xxx"
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ── Phase 46: Per-Merchant Fee Profile ──────────────────────────────

model MerchantFeeProfile {
  id          String   @id @default(cuid())
  merchantId  String   @unique
  mode        String   @default("percent") // percent | fixed | hybrid | none
  percentBps  Int      @default(75)        // 0.75% = 75 bps
  fixedFee    Decimal  @db.Decimal(18, 2) @default(0)
  currency    String   @default("HTG")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  merchant    Merchant @relation(fields: [merchantId], references: [id])
}

// ── Phase 27: Virtual Card Engine ──────────────────────────────────

model VirtualCard {
  id            String   @id @default(cuid())
  userId        String

  cardNumberEnc String   // AES-256-GCM encrypted
  fingerprint   String   @unique // SHA-256 of plaintext card number
  last4         String
  brand         String   @default("KOBKLEIN")

  expiryMonth   Int
  expiryYear    Int

  cvvHash       String   // bcrypt hash — never store plaintext

  currency      String   @default("USD")
  status        String   @default("active") // active | frozen | canceled

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions  VirtualCardTxn[]

  @@index([userId])
}

model VirtualCardTxn {
  id               String   @id @default(cuid())
  cardId           String
  userId           String

  status           String   @default("authorized") // authorized | captured | reversed | declined
  amount           Decimal  @db.Decimal(18, 2)
  currency         String

  merchantName     String?
  merchantCategory String?
  merchantCountry  String?

  holdId           String?  // links to hold ledger entry
  captureLedgerId  String?  // links to capture ledger entry

  meta             Json?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  card             VirtualCard @relation(fields: [cardId], references: [id])

  @@index([cardId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ── Phase 28: K-Pay Subscription Proxy ─────────────────────────────

model SubscriptionProxy {
  id                 String   @id @default(cuid())
  userId             String

  merchant           String   // NETFLIX, SPOTIFY, etc.
  externalAccountRef String?  // user's account email for that merchant

  amountUsd          Decimal  @db.Decimal(18, 2)
  currency           String   @default("USD")

  status             String   @default("active") // active | paused | canceled | delinquent

  nextBilling        DateTime
  lastCharged        DateTime?
  lastAttempt        DateTime?
  failureCount       Int      @default(0)

  meta               Json?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([merchant])
  @@index([status])
  @@index([nextBilling])
}

// ── Phase 29: K-Pay Store (Subscription Catalog) ────────────────────

model SubscriptionCatalogItem {
  id          String   @id @default(cuid())

  merchantKey String   @unique // "NETFLIX", "PRIME", "SPOTIFY"
  category    String   // "streaming", "music", "education", "tools"

  // Multilingual display
  nameEn      String
  nameFr      String
  nameHt      String
  nameEs      String

  descEn      String?
  descFr      String?
  descHt      String?
  descEs      String?

  active      Boolean  @default(true)

  plans       SubscriptionPlan[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SubscriptionPlan {
  id          String   @id @default(cuid())
  itemId      String

  item        SubscriptionCatalogItem @relation(fields: [itemId], references: [id])

  planKey     String   @unique // "NETFLIX_STANDARD", etc.
  amountUsd   Decimal  @db.Decimal(18, 2)
  interval    String   @default("monthly") // monthly (v1)

  // Multilingual labels
  labelEn     String
  labelFr     String
  labelHt     String
  labelEs     String

  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([itemId])
}

// ── Phase 32: Merchant POS Mode ─────────────────────────────────────

model MerchantPosRequest {
  id           String    @id @default(cuid())
  merchantId   String
  amount       Decimal   @db.Decimal(18, 2)
  currency     String    @default("HTG")
  note         String?
  status       String    @default("pending") // pending | paid | expired | canceled
  signature    String    // HMAC signature for QR integrity
  expiresAt    DateTime
  paidByUserId String?
  paidAt       DateTime?
  transferId   String?   // links to the ledger settlement
  createdAt    DateTime  @default(now())

  merchant     Merchant  @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
  @@index([status])
  @@index([expiresAt])
}

// ── Phase 40: Scheduled Remittance ──────────────────────────────────

model ScheduledTransfer {
  id              String    @id @default(cuid())
  senderUserId    String
  recipientUserId String
  familyLinkId    String?   // optional — ties to FamilyLink if diaspora
  amountUsd       Decimal   @db.Decimal(18, 2)
  frequency       String    @default("monthly") // weekly | biweekly | monthly
  nextRunAt       DateTime
  lastRunAt       DateTime?
  lastTransferId  String?   // last successful transfer ID
  failureCount    Int       @default(0)
  status          String    @default("active") // active | paused | canceled | failed
  note            String?   // "Mom's monthly support"
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sender          User      @relation("scheduledSender", fields: [senderUserId], references: [id])
  recipient       User      @relation("scheduledRecipient", fields: [recipientUserId], references: [id])

  @@index([senderUserId])
  @@index([status, nextRunAt])
}

// ── Phase 41: Risk Scoring Engine ───────────────────────────────────

model RiskEvent {
  id          String   @id @default(cuid())
  userId      String
  eventType   String   // transfer_attempt | login | cash_out | merchant_payment
  riskScore   Int      // 0-100
  riskLevel   String   // low | medium | high
  reasons     Json     // ["new_device", "high_velocity", ...]
  action      String   // allowed | otp_required | blocked | frozen
  transferId  String?  // if related to a specific transfer
  ip          String?
  userAgent   String?
  meta        Json?    // extra context (amount, currency, etc.)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([riskLevel, createdAt])
  @@index([eventType])
}

model AccountFlag {
  id         String    @id @default(cuid())
  userId     String
  flagType   String    // high_risk | watchlist | velocity_abuse | fraud_confirmed | pep
  reason     String?   // human-readable reason
  severity   Int       @default(2) // 1=low, 2=med, 3=high, 4=critical
  addedBy    String?   // admin userId or "system"
  resolvedAt DateTime?
  resolvedBy String?   // admin userId who resolved it
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([flagType])
  @@index([resolvedAt])
}
